{% extends "blog/base.html" %}
{% load static %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
  <div class="d-flex align-items-start justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h3 mb-1">{{ post.title }}</h1>
      <div class="text-muted small">{{ post.created_at|date:"Y-m-d H:i" }}</div>
      {% if post.categories.all %}
        <div class="mt-2 d-flex flex-wrap gap-1">
          {% for c in post.categories.all %}
            <a class="badge text-bg-light border text-decoration-none" href="{% url 'blog_post_list' %}?category={{ c.slug }}">{{ c.name }}</a>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    {% if request.user.is_staff %}
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm text-nowrap flex-shrink-0" href="{% url 'blog_post_edit' post.pk %}">수정</a>
        <a class="btn btn-outline-danger btn-sm text-nowrap flex-shrink-0" href="{% url 'blog_post_delete' post.pk %}">삭제</a>
      </div>
    {% endif %}
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      {% if post.content %}
        {{ post.content|safe }}
      {% else %}
        <p class="text-muted mb-0">내용이 비어있어요.</p>
      {% endif %}
    </div>
  </div>

  {% if quiz and quiz.questions.all %}
    <div class="card mt-3 quiz-card" data-quiz>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
          <div>
            <div class="kicker">Quiz</div>
            <div class="h5 mb-1">짧은 퀴즈</div>
            <div class="text-muted small">선택 후 “채점하기”를 누르면 바로 확인할 수 있어요.</div>
          </div>
          <button class="btn btn-outline-primary btn-sm text-nowrap" type="button" data-quiz-grade>채점하기</button>
        </div>

        <div class="d-grid gap-3">
          {% for q in quiz.questions.all %}
            <fieldset class="quiz-q" data-answer="{{ q.answer_index }}">
              <legend class="fw-semibold mb-2">{{ forloop.counter }}. {{ q.prompt }}</legend>
              <div class="d-grid gap-2">
                {% for choice in q.choices %}
                  <label class="quiz-choice d-flex align-items-start gap-2 p-2 rounded-3">
                    <input class="form-check-input mt-1" type="radio" name="q{{ forloop.parentloop.counter0 }}" value="{{ forloop.counter0 }}">
                    <span>{{ choice }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="quiz-msg text-muted small mt-2" aria-live="polite"></div>
            </fieldset>
          {% endfor %}
        </div>
      </div>
    </div>
    <script src="{% static 'js/quiz.js' %}" defer></script>
  {% endif %}

  {% if related_items %}
    <div class="card mt-3">
      <div class="card-body">
        <div class="side-title">연관된 생각</div>
        <div class="list-group list-group-flush">
          {% for item in related_items %}
            <a class="list-group-item list-group-item-action" href="{{ item.url }}">
              <div class="d-flex justify-content-between gap-2">
                <div class="fw-semibold title-wrap">{{ item.title }}</div>
                <span class="badge text-bg-light border">{% if item.kind == "post" %}Blog{% else %}Note{% endif %}</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  {% if timeline_items %}
    <div class="card mt-3">
      <div class="card-body">
        <div class="side-title">타임라인</div>
        <div class="list-group list-group-flush">
          {% for item in timeline_items %}
            <a class="list-group-item list-group-item-action" href="{{ item.url }}">
              <div class="d-flex justify-content-between gap-2">
                <div class="title-wrap">{{ item.title }}</div>
                <small class="text-muted">{{ item.date|date:"Y-m-d" }}</small>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  <div class="mt-3">
    <a class="btn btn-outline-secondary btn-sm text-nowrap" href="{% url 'blog_post_list' %}">← 목록</a>
  </div>
{% endblock %}
